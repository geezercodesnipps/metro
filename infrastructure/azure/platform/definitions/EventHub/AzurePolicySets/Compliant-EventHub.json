{
  "type": "Microsoft.Authorization/policySetDefinitions",
  "apiVersion": "2021-06-01",
  "name": "Compliant-Event-Hub",
  "properties": {
    "metadata": {
      "version": "1.0.0",
      "category": "Event Hub"
    },
    "policyType": "Custom",
    "displayName": "Enforce secure-by-default Event Hub for regulated industries",
    "description": "This policy initiative is a group of policies that ensures Event Hub is compliant per regulated Landing Zones",
    "policyDefinitionGroups": [
      {
        "name": "Encryption",
        "category": "Data Protection",
        "displayName": "Ensure compliance for purge protection, soft delete, and key rotation",
        "description": "Policy to ensure compliance for purge protection, soft delete, and key rotation"
      },
      {
        "name": "Network",
        "category": "Network Security",
        "displayName": "Ensure Event Hub is not accessible over the public internet",
        "description": "Policy to ensure Event Hub is not accessible over the public internet"
      },
      {
        "name": "Identity",
        "category": "Identity Management",
        "displayName": "Ensure usage of centralized identity and auhtorization system for Event Hub",
        "description": "Policy to ensure Event Hub is not using local authorization"
      },
      {
        "name": "Logging",
        "category": "Logging and Threat Detection",
        "displayName": "Ensure Event Hub is logging all events to Log Analytics",
        "description": "Policy to ensure Event Hub is logging all events to Log Analytics workspace"
      }
    ],
    "parameters": {
      "eventHubAuthRules": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubNamespacesLocalAuth": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubNamespacesModifyLocalAuth": {
        "type": "string",
        "defaultValue": "Modify"
      },
      "eventHubNamespacesPublicNetworkAccess": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubNamespacesDoubleEncryption": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubNamespacesCmk": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubDiagnostics": {
        "type": "string",
        "defaultValue": "DeployIfNotExists"
      },
      "eventHubLogAnalyticsWorkspaceId": {
        "type": "string",
        "defaultValue": ""
      },
      "eventHubMinTls": {
        "type": "string",
        "defaultValue": "Deny"
      },
      "eventHubPremiumCmk": {
        "type": "string",
        "defaultValue": "Deny"
      }
    },
    "policyDefinitions": [
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/1f6e93e8-6b31-41b1-83f6-36e449a42579",
        "policyDefinitionReferenceId": "Dine-Diagnostics-EH",
        "groupNames": [
          "Logging"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubDiagnostics')]"
          },
          "logAnalytics": {
            "value": "[parameters('eventHubLogAnalyticsWorkspaceId')]"
          }
        }
      },
      {
        "policyDefinitionId": "${scope_id_root}/providers/Microsoft.Authorization/policyDefinitions/Deny-EH-Cmk",
        "policyDefinitionReferenceId": "Deny-EH-Cmk",
        "groupNames": [
          "Encryption"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubNamespacesCmk')]"
          }
        }
      },
      {
        "policyDefinitionId": "${scope_id_root}/providers/Microsoft.Authorization/policyDefinitions/Deny-EH-MINTLS",
        "policyDefinitionReferenceId": "Deny-EH-MINTLS",
        "groupNames": [
          "Encryption"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubMinTls')]"
          }
        }
      },
      {
        "policyDefinitionId": "${scope_id_root}/providers/Microsoft.Authorization/policyDefinitions/Deny-EH-Premium-CMK",
        "policyDefinitionReferenceId": "Deny-EH-Premium-CMK",
        "groupNames": [
          "Encryption"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubPremiumCmk')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/836cd60e-87f3-4e6a-a27c-29d687f01a4c",
        "policyDefinitionReferenceId": "Deny-EH-Double-Encryption",
        "groupNames": [
          "Encryption"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubNamespacesDoubleEncryption')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/0602787f-9896-402a-a6e1-39ee63ee435e",
        "policyDefinitionReferenceId": "Dine-EH-Local-Auth",
        "groupNames": [
          "Network"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubNamespacesPublicNetworkAccess')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/57f35901-8389-40bb-ac49-3ba4f86d889d",
        "policyDefinitionReferenceId": "Modify-EH-Local-Auth",
        "groupNames": [
          "Identity"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubNamespacesModifyLocalAuth')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/5d4e3c65-4873-47be-94f3-6f8b953a3598",
        "policyDefinitionReferenceId": "Deny-EH-Local-Auth",
        "groupNames": [
          "Identity"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubNamespacesLocalAuth')]"
          }
        }
      },
      {
        "policyDefinitionId": "/providers/Microsoft.Authorization/policyDefinitions/b278e460-7cfc-4451-8294-cccc40a940d7",
        "policyDefinitionReferenceId": "Deny-EH-Auth-Rules",
        "groupNames": [
          "Identity"
        ],
        "parameters": {
          "effect": {
            "value": "[parameters('eventHubAuthRules')]"
          }
        }
      }
    ]
  }
}
